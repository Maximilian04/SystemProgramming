Turbo Assembler	 Version 4.1	    04/20/23 23:57:10	    Page 1
keymag.asm



      1	0000			     .model tiny
      2	0000			     .code
      3				     .286
      4				     locals @@
      5				     org 100h
      6
      7	      =000A		     boxWidth  = 10d
      8	      =000D		     boxHeight = 13d
      9	      =0002		     boxTheme  = 2
     10	      =000E		     boxColor  = 00Eh
     11
     12	0100  E9 008C		     Start:	     jmp Main
     13
     14
     15				     ;------------------------------------------------
     16				     ; Keyboard	intterupt handler
     17				     ;------------------------------------------------
     18				     ;
     19				     ;	 Catches control keys &	sets (State) variable
     20				     ;
     21				     ;------------------------------------------------
     22
     23	0103			     New09Int	     proc
     24	0103  60				     pusha		     ; Stored regs
     25						     ; mov ax, cs
     26						     ; mov ds, ax
     27
     28	0104  E4 60				     in	al, 60h		     ; Catch key code
     29
     30	0106  3C 1D				     cmp al, 01Dh	     ; ctrl is pressed
     31	0108  74 03				     je	@@ControlKey1
     32						     ; cmp al, 09Dh	       ; ctrl is released
     33						     ; je @@ControlKey2
     34
     35	010A  EB 21 90				     jmp @@NotControlKey
     36	010D					 @@ControlKey1:
     37									     ; CTRL is pressed
     38
     39
     40
     41	010D  2E: 8B 3E	0135r			     mov di, word ptr cs:[CurPos]
     42	0112  BB 000E				     mov bx, 0Eh
     43
     44	0115			     @@CycleChar:				     ; <-------------------------\
     45	0115  81 FF 018Fr			     cmp di, offset StrEnd	     ;				 |
     46	0119  7D 0D				     jge @@CycleEnd		     ; >-----\			 |
     47										     ;	     |			 |
     48	011B  B5 00				     mov ch, 0			     ;	     |			 |
     49	011D  2E: 8A 0D				     mov cl, cs:[di]		     ;	     |			 |
     50	0120  47				     inc di			     ;	     |			 |
     51										     ;	     |			 |
     52	0121  B4 05				     mov ah, 5h			     ; put cx to keyboard	 |
     53	0123  CD 16				     int 16h			     ;	     |			 |
     54										     ;	     |			 |
     55	0125  4B				     dec bx			     ;	     |			 |
     56	0126  75 ED				     jnz @@CycleChar		     ; >-----+-------------------/
     57										     ;	     |
Turbo Assembler	 Version 4.1	    04/20/23 23:57:10	    Page 2
keymag.asm



     58	0128					 @@CycleEnd:			     ; <-----/
     59	0128  2E: 89 3E	0135r			     mov word ptr cs:[CurPos], di
     60
     61
     62	012D					 @@NotControlKey:
     63
     64
     65	012D  61				     popa		     ; Stored regs
     66	012E  9C				     pushf
     67	012F  9A				     db	09Ah		     ; CALL FAR
     68	0130  0000		     Old09Ofs	     dw	0		     ; call old	09 interruption
     69	0132  0000		     Old09Seg	     dw	0
     70
     71	0134  CF				     iret
     72	0135					     endp
     73
     74				     ;------------------------------------------------
     75				     ;------------------------------------------------
     76
     77	0135  0137r		     CurPos:	     dw	offset String
     78	0137			     String:
     79	0137  4E*(A7)				     db	(50h - 2h) DUP(167d)
     80	0185  0A*(02)				     db	0Ah DUP(2d)
     81						     ; db 1F8h DUP("a")
     82						     ; db "You are great!"
     83	018F			     StrEnd:
     84
     85	018F			     InterruptorMemEnd:
     86
     87	018F			     Main:
     88	018F  FA				     cli
     89	0190  BB 0000				     mov bx, 0
     90	0193  8E C3				     mov es, bx
     91	0195  BB 0024				     mov bx, 9*4			 ; DOS interruption address offset
     92
     93	0198  26: 8B 07				     mov ax, es:[bx]			 ; Old interrupt-09 handler
     94	019B  A3 0130r				     mov Old09Ofs, ax
     95	019E  26: 8B 47	02			     mov ax, es:[bx+2]
     96	01A2  A3 0132r				     mov Old09Seg, ax
     97
     98	01A5  26: C7 07	0103r			     mov es:[bx], offset New09Int	 ; Set my interrupt-09 handler
     99	01AA  8C C8				     mov ax, cs
    100	01AC  26: 89 47	02			     mov es:[bx+2], ax
    101	01B0  FB				     sti
    102
    103
    104	01B1  B8 3100				     mov ax, 3100h
    105	01B4  BA 018Fr				     mov dx, offset InterruptorMemEnd	 ; Размер	необходимой	    +
    106				     памяти
    107	01B7  C1 EA 04				     shr dx, 4				 ; В параграфе 16 байт
    108	01BA  42				     inc dx				 ; С округлением вверх
    109
    110	01BB  CD 21				     int 21h
    111
    112						     ; mov ax, 4c00h		       ; exit(0)
    113						     ; int 21h
    114
Turbo Assembler	 Version 4.1	    04/20/23 23:57:10	    Page 3
keymag.asm



    115				     end	     Start
Turbo Assembler	 Version 4.1	    04/20/23 23:57:10	    Page 4
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "04/20/23"
??FILENAME			  Text	 "keymag  "
??TIME				  Text	 "23:57:10"
??VERSION			  Number 040A
@32BIT				  Text	 0
@@CONTROLKEY1			  Near	 DGROUP:010D
@@CYCLECHAR			  Near	 DGROUP:0115
@@CYCLEEND			  Near	 DGROUP:0128
@@NOTCONTROLKEY			  Near	 DGROUP:012D
@CODE				  Text	 DGROUP
@CODESIZE			  Text	 0
@CPU				  Text	 0707H
@CURSEG				  Text	 _TEXT
@DATA				  Text	 DGROUP
@DATASIZE			  Text	 0
@FILENAME			  Text	 KEYMAG
@INTERFACE			  Text	 000H
@MODEL				  Text	 1
@STACK				  Text	 DGROUP
@WORDSIZE			  Text	 2
BOXCOLOR			  Number 000E
BOXHEIGHT			  Number 000D
BOXTHEME			  Number 0002
BOXWIDTH			  Number 000A
CURPOS				  Near	 DGROUP:0135
INTERRUPTORMEMEND		  Near	 DGROUP:018F
MAIN				  Near	 DGROUP:018F
NEW09INT			  Near	 DGROUP:0103
OLD09OFS			  Word	 DGROUP:0130
OLD09SEG			  Word	 DGROUP:0132
START				  Near	 DGROUP:0100
STREND				  Near	 DGROUP:018F
STRING				  Near	 DGROUP:0137

Groups & Segments		  Bit Size Align  Combine Class

DGROUP				  Group
  _DATA				  16  0000 Word	  Public  DATA
  _TEXT				  16  01BD Word	  Public  CODE
